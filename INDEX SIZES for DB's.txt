DECLARE @dbid INT
DECLARE @dbname NVARCHAR(128)
DECLARE @indexSizeUsage TABLE (
    database_id INT,
    database_name NVARCHAR(128),
    index_size_mb FLOAT
)

DECLARE db_cursor CURSOR FOR
SELECT database_id, name
FROM sys.databases
WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb')

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @dbid, @dbname

WHILE @@FETCH_STATUS = 0
BEGIN
    DECLARE @sql NVARCHAR(MAX) = '
    USE ' + QUOTENAME(@dbname) + ';
    SELECT DB_ID() AS database_id,
        DB_NAME() AS database_name,
        SUM(used_page_count) * 8 / 1024 AS index_size_mb
    FROM sys.dm_db_partition_stats
    WHERE index_id > 0;'
    
    INSERT INTO @indexSizeUsage (database_id, database_name, index_size_mb)
    EXEC sp_executesql @sql
    
    FETCH NEXT FROM db_cursor INTO @dbid, @dbname
END

CLOSE db_cursor
DEALLOCATE db_cursor

SELECT * FROM @indexSizeUsage
ORDER BY index_size_mb DESC
